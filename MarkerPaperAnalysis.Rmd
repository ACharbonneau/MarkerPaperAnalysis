---
title: "MarkerPaperAnalysis"
author: "Amanda Charbonneau"
date: "December 10, 2014"
output: html_document
---


```{r Settings, echo=FALSE, message=FALSE}

rm( list=ls())
require(lme4)
FlowData <- read.csv("CombinedDataSet.csv")

```
##Does days to flowering differ between native and non-native range populations of *R.r. raphanistrum*?
*R.r. raphanistrum* is native to the area around the Mediterranean, and it has been suggested that it originated on the western side where Raphanus diversity is highest. We have *R.r. raphanistrum* populations from three main geographic areas: the western side of teh Mediterranean (all from France or Spain), the eastern side of the Mediterranean (all from Israel), and non-native. To test whether there is a difference in flowering time between native and non-natives, and also look for differences between native populations on either side of the Mediterranean Sea, we are modeling a subset of the data that only includes *R.r. raphanistrum* populations. 
```{r SubsetRrr, echo=FALSE}
#Subset out only the *R.r. raphanistrum* populations, and re-factor to make the western populations the base.

RrrData <- droplevels(FlowData[FlowData$Taxonomy == "raphanistrum",])
RrrData$Geography <- relevel(RrrData$Geography, "west")
RrrData$Habitat <- relevel(RrrData$Habitat, "natural")
RrrData$GermDate <- as.Date(RrrData$GermDate)
RrrData$DOY <- strftime(RrrData$PlantDate, format = "%j")
RrrData$DOY <- as.numeric(RrrData$DOY)
RrrData$DaysVernNoNA <- RrrData$DaysVern
RrrData$DaysVernNoNA[is.na(RrrData$DaysVernNoNA)] <- 0

```

###Models for *R.r. raphanistrum*
We want to model days to flowering as a function of Geography. As our datasets were done at different times and places, this is an idealized model which attempts to account for all known sources of variation caused by differences in experimental design.

#####Model
```{r Model1Rrr, echo=TRUE, eval=FALSE}
lmer( PTF ~ Geography + as.Date(GermDate) + Vernalized*DaysVern + Seedstock + GrowthEnvironment + GrowthEnvironment:Geography + (1 + Geography|Experiment) + (1 + Year) + (1|Geography:Pop), data=RrrData  )
```

####Fixed Effects

**GermDate** accounts for variation in seasons, as experiments were started at different times of year and so experianced differing growth conditions like length of day and light intensity.

**Vernalized**`*`**DaysVern** accounts for whether an individual was vernalized, and for how long

**Seedstock** accounts for variation due to parental effects (mothers grown in greenhouse or outside)

**GrowthEnvironment** accounts for variation due to the study plant being growth in the greenhouse or field

The interaction term **GrowthEnvironment:Geography** allows populations from each region to have independent reactions to **GrowthEnvironment**

####Random Effects

The **Geography**|**Experiment** term accounts for apparent variance due to **Geography** that may be due to differnces between **Experiment**s

The **Year** term reflects how much overall variance there is among years

The **Geography**:**Pop** term accounts for the differences among means (intercepts) for each level of **Geography**:**Pop**
                  
However, this model doesn't work. First, the **Geography**:**Pop** term is actually pointless, because no population occurs in more than on geographic region, so this is basically just fitting population as a random effect. We can accomplish the same thing by adding in an effect of population as a random effect ```(1|Pop)```.

Second, in this data subset, **Year** is colinear with **Experiment**:

```{r Error1Rrr, echo=FALSE}
with(RrrData, table(Year, Experiment))
```
Third, **GermDate** is an actual date, which seems to make the model do weird things. The dates include year, and in each experiment, all individuals had roughly the same germination date, so most of differences that the model finds with this variable are likely to be year effects, which we already know will be colinear with experiment. Since this variable is supposed to capture variation in time of year for germination, rather than year variation, I am re-formatting this column to be the day of the year (1-365) rather than a date. This is stored as a new column **DOY**.

Finally, the **Vernalized**`*`**DaysVern** is fitting three things: whether a plant was vernalized, how long it was vernalized, and the interaction between them. I'm not sure this is really what we want. Instead, I've created a new variable **DaysVernNoNA** that has only zeros and positive integers, so plants either had no vernalization, or some number of days.

If we rewrite the model to accomadate these changes we get:

```{r DataEdits1, echo=FALSE}
RrrData$DOY <- strftime(RrrData$GermDate, format = "%j")
RrrData$DOY <- as.numeric(RrrData$DOY)
RrrData$DaysVernNoNA <- RrrData$DaysVern
RrrData$DaysVernNoNA[is.na(RrrData$DaysVernNoNA)] <- 0
```

```{r Model2Rrr, echo=TRUE, eval=FALSE}

lmer( PTF ~ Geography +  Seedstock + GrowthEnvironment + DaysVernNoNA + DOY + GrowthEnvironment:Geography + (1 + Geography|Experiment) + (1|Pop), data=RrrData)

```

Which is a model that gives estimates, but also lots of errors:

```{r Error2Rrr, echo=FALSE, error=TRUE, results='hide'}

lmer( PTF ~ Geography +  Seedstock + GrowthEnvironment + DaysVernNoNA + DOY + GrowthEnvironment:Geography + (1 + Geography|Experiment) + (1|Pop), data=RrrData)

```

These errors seem to be being caused by the **DOY**, **DaysVernNoNA** and **GrowthEnvironment:Geography** terms. **DaysVernNoNA** appears to be causing a problem because of a lack of balance. MAES is the only population that experianced vernalization, so it causes a rank-deficiency. 

```{r Error3Rrr, echo=FALSE}
 with(RrrData, table(DaysVernNoNA, Pop))
```
**DOY** also causes a rank deficiency, although I can't figure out why. It might be because there are so many NA's, since Jeff didn't record germination date for many experiments. So, I changed **DOY** again, so now it's day of year of planting rather than germination, because we have almost all that data, and it will still capture variation in time of year. I couldn't find any reason that the **GrowthEnvironment:Geography** term should be causing a problem, but by just changing the **DOY** term, the model now converges, even though MAES still may be making some weirdness.

```{r DataEdits2, echo=FALSE}
RrrData$DOY <- strftime(RrrData$PlantDate, format = "%j")
RrrData$DOY <- as.numeric(RrrData$DOY)
```

```{r Model2RrrFixed, echo=FALSE}
AllTermsModel <- lmer( PTF ~ Geography +  Seedstock + GrowthEnvironment + DaysVernNoNA + DOY + GrowthEnvironment:Geography + (1 + Geography|Experiment) + (1|Pop), data=RrrData)

ATM <- summary(AllTermsModel)
ATM
```
For instance, the variance on experiment is `r round(ATM$varcor$Experiment[1,1], 2)`, for a SD of `r round(attr(ATM$varcor$Experiment, "stddev")[1], 2)`, which is somewhat larger than the estimate of `r round(ATM$coefficients[1], 2)` for the overall mean of days to flowering. The variance due to geography is higher still. This suggests that although we can get point estimates for fixed effects in this model, they are not going to give us the ability to say any one point estimate is different from any other.

My first guess of how one might fix this is to try to fit fewer effects, as I may be over-stretching the data. However, now that I've made fewer NA's and the model converges with all of the data, I can no longer subtract out terms and have it work: 

```{r Model3RrrFixed, echo=TRUE, message=FALSE}
MostTermsModel <- lmer( PTF ~ Geography +  Seedstock + GrowthEnvironment + DOY + GrowthEnvironment:Geography + (1 + Geography|Experiment) + (1|Pop), data=RrrData)

```

It has the same error if I take out **Geography**, **DOY**, **GrowthEnvironment**,  **DaysVernNoNA**, or **GrowthEnvironment:Geography**. 

However, I can substitute in **Habitat**, which is another reasonable variable to add to the model, for most of them, and it will still run.

```{r Model4Rrr, echo=TRUE}
HabitatModel <- lmer( PTF ~ Geography +  Seedstock + Habitat + DaysVernNoNA  + DOY + GrowthEnvironment:Geography + (1 + Geography|Experiment) + (1|Pop), data=RrrData)
HAB <- summary(HabitatModel)
```

Unfortunatly, the base intercept changes quite a bit: `r round(HAB$coefficients[1], 2)`, and still has a large variance: `r round(HAB$coefficients[1], 2)`. And these numbers flucuate fairly wildly depending on which variable I exchange. This all suggests that the all the terms are important, and/or the model isn't estimating very well.
 
So, I tried running the full model in MCMCglmm, to see if it did any better in a Bayesian framework. Short answer: not really.

It won't run at all with the full model that worked in lmer:
```{r Settings2, echo=FALSE, message=FALSE }
require(MCMCglmm)
```

```{r Model5Rrr, echo=FALSE, error=TRUE, results='hide' }
AllTermsModelMCMC <- MCMCglmm( PTF ~ 1 + Geography + Seedstock + GrowthEnvironment + DaysVernNoNA + DOY + GrowthEnvironment:Geography, random= ~Pop + idh(Geography|Experiment), data=RrrData, verbose=F, burnin=1000, nitt=100000, thin=5)
```
For whatever reason, it insists that it can't work because there are a handful of NA values. 

It will run if I remove the **DOY** variable, but with several warnings:
```{r Model6Rrr, echo=FALSE}
MostTermsModelMCMC <- MCMCglmm( PTF ~ 1 + Geography + Seedstock + GrowthEnvironment + DaysVernNoNA + GrowthEnvironment:Geography, random= ~Pop + idh(Geography|Experiment), data=RrrData, verbose=F, burnin=1000, nitt=100000, thin=5)
```

Somewhat more problematically, it doesn't seem to be estimating terribly well either. It seems to think that the base intercept is ```r summary(MostTermsModelMCMC)$solutions[1]```, which may or may not be a reasonable number when you run it, but for me tends to be between -200 and 200, and at the moment is -190, which I think we can all agree is not a terribly useful days to flowering estimate. Worse, the 95% credible intervals are consistantly from ```r round(summary(MostTermsModelMCMC)$solutions[9], 2)``` to ```r round(summary(MostTermsModelMCMC)$solutions[17], 2)```. In other words, MCMCglmm can't get very good estimates either. The base intercept trace shows that MCMCglmm has no idea where it should look, and isn't narrowing down it's search after 100000 iterations. (I've also tried 1000000, and it doesn't get better)

Most of the other traces do mostly converge and give reasonable looking density plots, however I'm not sure how accurate to expect they are given that they are supposed to be deviations from a wildly flucuating base. I'm plotting the base and deviation for east in geography for examples.

```{r, echo=FALSE}
plot(MostTermsModelMCMC$Sol[,1])
plot(MostTermsModelMCMC$Sol[,2])

```

This is just a reminder to myself that there are still some issues with the data itself, so I may need to get rid of some datapoints. Specifically:

There are some issues with the flowering time data for MAES and SAES only in Heather's 2003 parents and 2004 offspring (this is what took all this time; I am still waiting to hear if Heather has these dates, but I am not hopeful).  I think the flowering times are underestimated for two reasons -- there were additional MAES and SAES parents that flowered much later after vernalization, but I can't find the flowering times for these so they are not included at all (so the data are right censored).  Unfortunately, I can't say for sure which plants actually germinated and then did or did not flower; I know some of the ones that flowered in SAES, but not the fates of the others.  The other underestimate is that the flowering times do not include the period of vernalization for MAES offspring only (they do for SAES and in all other datasets, and none of the 15% of MAES parents that flowered after vernalization are in the dataset as stated above).






